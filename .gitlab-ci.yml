stages:
  - quality-check
  - test
  - tag
  - release

# å…¨å±€å˜é‡
variables:
  RUBY_VERSION: "3.2.9"
  BUNDLER_VERSION: "2.5.22"

# å¤ç”¨çš„è„šæœ¬æ¨¡æ¿
.ruby_setup: &ruby_setup
  image: ruby:$RUBY_VERSION
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - vendor/bundle
  before_script:
    - gem install bundler -v $BUNDLER_VERSION
    - bundle config set --local path 'vendor/bundle'
    - bundle install --jobs $(nproc)

# ========================================
# MR è´¨é‡æ£€æŸ¥ (å¯¹åº” pr-check.yml)
# ========================================
mr-quality-check:
  <<: *ruby_setup
  stage: quality-check
  only:
    - merge_requests
  script:
    - echo "ğŸ” è¿è¡Œ Danger è¿›è¡Œ MR è´¨é‡æ£€æŸ¥..."
    - bundle exec danger
  allow_failure: false

# ========================================
# CI æµ‹è¯• (å¯¹åº” ci.yml)
# ========================================
ci-test:
  <<: *ruby_setup
  stage: test
  only:
    - main
    - develop
    - merge_requests
  script:
    - echo "ğŸ§ª å¼€å§‹ CI æµ‹è¯•..."
    - |
      PODSPEC=$(ls *.podspec | head -n 1)
      if [ -z "$PODSPEC" ]; then
        echo "âŒ æœªæ‰¾åˆ° .podspec æ–‡ä»¶"
        exit 1
      fi
      echo "éªŒè¯ podspec: $PODSPEC"
      bundle exec pod lib lint $PODSPEC --allow-warnings --verbose
  allow_failure: false

# ========================================
# è‡ªåŠ¨æ‰“ Tag (å¯¹åº” auto-tag.yml)
# ========================================
auto-tag:
  <<: *ruby_setup
  stage: tag
  only:
    refs:
      - main
    changes:
      - "*.podspec"
  script:
    - echo "ğŸ“¦ æ£€æµ‹åˆ° podspec å˜æ›´ï¼Œå¼€å§‹è‡ªåŠ¨æ‰“ Tag..."
    
    # 1. æå–ç‰ˆæœ¬å·
    - |
      PODSPEC_FILE=$(find . -maxdepth 1 -name "*.podspec" | head -n 1)
      if [ -z "$PODSPEC_FILE" ]; then
        echo "âŒ æœªæ‰¾åˆ° .podspec æ–‡ä»¶"
        exit 1
      fi
      echo "æ‰¾åˆ° podspec æ–‡ä»¶: $PODSPEC_FILE"
    
    - |
      VERSION=$(grep -E '(s|spec)\.version.*=.*"[^"]*"' "$PODSPEC_FILE" | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+')
      if [ -z "$VERSION" ]; then
        echo "âŒ æ— æ³•ä» podspec ä¸­æå–ç‰ˆæœ¬å·"
        cat "$PODSPEC_FILE"
        exit 1
      fi
      TAG_NAME="$VERSION"
      echo "ğŸ“¦ æ£€æµ‹åˆ°ç‰ˆæœ¬: $TAG_NAME"
    
    # 2. æ£€æŸ¥ Tag æ˜¯å¦å·²å­˜åœ¨
    - |
      if git rev-parse "refs/tags/$TAG_NAME" >/dev/null 2>&1; then
        echo "â„¹ï¸  Tag $TAG_NAME å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
        exit 0
      else
        echo "âœ¨ Tag $TAG_NAME ä¸å­˜åœ¨ï¼Œå‡†å¤‡åˆ›å»º"
      fi
    
    # 3. éªŒè¯ CHANGELOG
    - |
      if [ ! -f "CHANGELOG.md" ]; then
        echo "âŒ CHANGELOG.md æ–‡ä»¶ä¸å­˜åœ¨"
        exit 1
      fi
      if ! grep -q "\[$VERSION\]" CHANGELOG.md; then
        echo "âŒ CHANGELOG.md ä¸­ç¼ºå°‘ç‰ˆæœ¬ $VERSION çš„è®°å½•"
        echo "è¯·åœ¨ CHANGELOG.md ä¸­æ·»åŠ ç‰ˆæœ¬æ›´æ–°è¯´æ˜åå†åˆå¹¶"
        exit 1
      fi
      echo "âœ… CHANGELOG éªŒè¯é€šè¿‡"
    
    # 4. åˆ›å»ºå¹¶æ¨é€ Tag
    - |
      git config user.name "GitLab CI"
      git config user.email "gitlab-ci@gitlab.com"
      git tag -a "$TAG_NAME" -m "Release version $VERSION"
      git push "https://oauth2:${CI_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "$TAG_NAME"
      echo "ğŸ‰ æˆåŠŸåˆ›å»ºå¹¶æ¨é€ tag: $TAG_NAME"
    
    # 5. åˆ›å»º GitLab Release
    - |
      RELEASE_DESCRIPTION="## Release $VERSION

      è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬ $VERSION
      
      æŸ¥çœ‹ [CHANGELOG.md](${CI_PROJECT_URL}/-/blob/main/CHANGELOG.md) è·å–è¯¦ç»†æ›´æ–°å†…å®¹ã€‚"
      
      curl --request POST \
        --header "PRIVATE-TOKEN: ${CI_PUSH_TOKEN}" \
        --data "tag_name=$TAG_NAME" \
        --data "name=Release v$TAG_NAME" \
        --data "description=$RELEASE_DESCRIPTION" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"
      
      echo "ğŸ‰ æˆåŠŸåˆ›å»º GitLab Release: $TAG_NAME"

# ========================================
# Tag éªŒè¯ (å¯¹åº” tag-check.yml)
# ========================================
tag-validation:
  <<: *ruby_setup
  stage: release
  only:
    - tags
  script:
    - echo "ğŸ” éªŒè¯ Tag: $CI_COMMIT_TAG"
    
    # 1. éªŒè¯ Tag æ ¼å¼
    - |
      TAG=$CI_COMMIT_TAG
      if [[ ! $TAG =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
        echo "âŒ Tagæ ¼å¼é”™è¯¯: $TAG"
        echo "è¯·ä½¿ç”¨æ ¼å¼: 1.2.3 æˆ– 1.2.3-beta.1"
        exit 1
      fi
      echo "âœ… Tagæ ¼å¼æ­£ç¡®"
    
    # 2. æ£€æŸ¥ podspec ç‰ˆæœ¬
    - |
      VERSION=$TAG
      PODSPEC_VERSION=$(grep -E '(s|spec)\.version.*=.*"[^"]*"' *.podspec | grep -o '[0-9.]\+')
      echo "Tagç‰ˆæœ¬: $VERSION"
      echo "Podspecç‰ˆæœ¬: $PODSPEC_VERSION"
      if [ "$PODSPEC_VERSION" != "$VERSION" ]; then
        echo "âŒ Podspecç‰ˆæœ¬($PODSPEC_VERSION)ä¸tagç‰ˆæœ¬($VERSION)ä¸åŒ¹é…"
        exit 1
      fi
      echo "âœ… ç‰ˆæœ¬å·åŒ¹é…"
    
    # 3. æ£€æŸ¥ CHANGELOG
    - |
      if ! grep -q "\[$VERSION\]" CHANGELOG.md; then
        echo "âŒ CHANGELOG.mdä¸­ç¼ºå°‘ç‰ˆæœ¬$VERSIONçš„è®°å½•"
        echo "è¯·åœ¨CHANGELOG.mdä¸­æ·»åŠ : ## [$VERSION] - $(date +%Y-%m-%d)"
        exit 1
      fi
      echo "âœ… CHANGELOGå·²æ›´æ–°"
    
    # 4. è¿è¡Œ Fastlane å‘å¸ƒå‰æ£€æŸ¥
    - gem install fastlane
    - fastlane pre_release_check version:$CI_COMMIT_TAG || true
    
    - echo "ğŸ‰ ç‰ˆæœ¬ $CI_COMMIT_TAG éªŒè¯é€šè¿‡ï¼Œå¯ä»¥å®‰å…¨å‘å¸ƒï¼"
